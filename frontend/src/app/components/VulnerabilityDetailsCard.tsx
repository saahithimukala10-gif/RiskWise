import { useState } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/app/components/ui/card';
import { Input } from '@/app/components/ui/input';
import { Label } from '@/app/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/app/components/ui/select';
import { Switch } from '@/app/components/ui/switch';
import { Button } from '@/app/components/ui/button';
import { Shield, Zap, Loader2 } from 'lucide-react';
import { hexColors } from '@/config/colors';
import type { RiskAssessmentRequest } from '@/types/risk';

interface VulnerabilityDetailsCardProps {
  onSubmit: (data: RiskAssessmentRequest) => void;
  isLoading: boolean;
}

export function VulnerabilityDetailsCard({ onSubmit, isLoading }: VulnerabilityDetailsCardProps) {
  const [cvssScore, setCvssScore] = useState('5.0');
  const [vulnerabilityType, setVulnerabilityType] = useState('');
  const [owaspCategory, setOwaspCategory] = useState('');
  const [exploitAvailable, setExploitAvailable] = useState(false);
  const [authRequired, setAuthRequired] = useState(true);
  const [internetExposed, setInternetExposed] = useState(false);
  const [attackComplexity, setAttackComplexity] = useState<'low' | 'high'>('high');
  const [assetValue, setAssetValue] = useState<'low' | 'medium' | 'critical'>('low');

  const handleSubmit = () => {
    // Validate form
    if (!vulnerabilityType || !owaspCategory) {
      alert('Please select vulnerability type and OWASP category');
      return;
    }

    const requestData: RiskAssessmentRequest = {
      cvss_score: parseFloat(cvssScore),
      vulnerability_type: vulnerabilityType,
      owasp_category: owaspCategory,
      exploit_available: exploitAvailable,
      auth_required: authRequired,
      internet_exposed: internetExposed,
      attack_complexity: attackComplexity,
      asset_value: assetValue,
    };

    onSubmit(requestData);
  };

  return (
    <Card className="w-full" style={{
      background: `linear-gradient(135deg, ${hexColors.brown.dark}99 0%, ${hexColors.navy.dark}99 100%)`,
      backdropFilter: 'blur(10px)',
      border: '1px solid rgba(255, 255, 255, 0.1)',
    }}>
      <CardHeader>
        <div className="flex items-start gap-3">
          <div className="rounded-full p-3" style={{ 
            background: `linear-gradient(135deg, ${hexColors.navy.light}40 0%, ${hexColors.brown.light}40 100%)`,
          }}>
            <Shield className="size-6 text-white" />
          </div>
          <div>
            <CardTitle className="text-white">Vulnerability Details</CardTitle>
            <CardDescription className="text-white/60">
              Enter the vulnerability characteristics for AI-powered risk assessment
            </CardDescription>
          </div>
        </div>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* Vulnerability Type - First */}
        <div className="space-y-2">
          <Label className="text-white">Vulnerability Type</Label>
          <Select value={vulnerabilityType} onValueChange={setVulnerabilityType} disabled={isLoading}>
            <SelectTrigger className="bg-white/5 border-white/10 text-white">
              <SelectValue placeholder="Select vulnerability type" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="sql-injection">SQL Injection</SelectItem>
              <SelectItem value="xss">Cross-Site Scripting (XSS)</SelectItem>
              <SelectItem value="csrf">Cross-Site Request Forgery (CSRF)</SelectItem>
              <SelectItem value="rce">Remote Code Execution (RCE)</SelectItem>
              <SelectItem value="path-traversal">Path Traversal</SelectItem>
              <SelectItem value="idor">Insecure Direct Object Reference (IDOR)</SelectItem>
<SelectItem value="xxe">XML External Entity (XXE)</SelectItem>
<SelectItem value="open-redirect">Open Redirect</SelectItem>
<SelectItem value="command-injection">OS Command Injection</SelectItem>
<SelectItem value="deserialization">Insecure Deserialization</SelectItem>
            </SelectContent>
          </Select>
        </div>

        {/* CVSS Score and OWASP Category - Same Line */}
        <div className="grid grid-cols-2 gap-4">
          {/* CVSS Score */}
          <div className="space-y-2">
            <Label className="text-white">CVSS Score</Label>
            <div className="relative">
              <Input
                type="number"
                value={cvssScore}
                onChange={(e) => setCvssScore(e.target.value)}
                className="pr-12 bg-white/5 border-white/10 text-white"
                min="0"
                max="10"
                step="0.1"
                disabled={isLoading}
              />
              <span className="absolute right-3 top-1/2 -translate-y-1/2 text-white/60">
                / 10
              </span>
            </div>
          </div>

          {/* OWASP Category */}
          <div className="space-y-2">
            <Label className="text-white">OWASP Category</Label>
            <Select value={owaspCategory} onValueChange={setOwaspCategory} disabled={isLoading}>
              <SelectTrigger className="bg-white/5 border-white/10 text-white">
                <SelectValue placeholder="Select OWASP category" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="a01">A01:2021 – Broken Access Control</SelectItem>
                <SelectItem value="a02">A02:2021 – Cryptographic Failures</SelectItem>
                <SelectItem value="a03">A03:2021 – Injection</SelectItem>
                <SelectItem value="a04">A04:2021 – Insecure Design</SelectItem>
                <SelectItem value="a05">A05:2021 – Security Misconfiguration</SelectItem>
                <SelectItem value="a06">A06:2021 – Vulnerable and Outdated Components</SelectItem>
<SelectItem value="a07">A07:2021 – Identification and Authentication Failures</SelectItem>
<SelectItem value="a08">A08:2021 – Software and Data Integrity Failures</SelectItem>
<SelectItem value="a09">A09:2021 – Security Logging and Monitoring Failures</SelectItem>
<SelectItem value="a10">A10:2021 – Server-Side Request Forgery (SSRF)</SelectItem>

              </SelectContent>
            </Select>
          </div>
        </div>
        
        {/* Security Context Section */}
        <div className="pt-4 border-t border-white/10">
          <h3 className="font-semibold text-sm text-white/60 mb-4">SECURITY CONTEXT</h3>
          
          {/* Toggles */}
          <div className="space-y-4">
            <div className="flex items-center justify-between">
              <Label htmlFor="exploit-available" className="cursor-pointer text-white">Exploit Available</Label>
              <div className="flex items-center gap-3">
                <span className="text-sm text-white/60">No</span>
                <Switch
                  id="exploit-available"
                  checked={exploitAvailable}
                  onCheckedChange={setExploitAvailable}
                  disabled={isLoading}
                  style={{
                    backgroundColor: exploitAvailable ? hexColors.navy.light : undefined,
                  }}
                />
                <span className="text-sm text-white/60">Yes</span>
              </div>
            </div>

            <div className="flex items-center justify-between">
              <Label htmlFor="auth-required" className="cursor-pointer text-white">Authentication Required</Label>
              <div className="flex items-center gap-3">
                <span className="text-sm text-white/60">No</span>
                <Switch
                  id="auth-required"
                  checked={authRequired}
                  onCheckedChange={setAuthRequired}
                  disabled={isLoading}
                  style={{
                    backgroundColor: authRequired ? hexColors.navy.light : undefined,
                  }}
                />
                <span className="text-sm text-white/60">Yes</span>
              </div>
            </div>

            <div className="flex items-center justify-between">
              <Label htmlFor="internet-exposed" className="cursor-pointer text-white">Internet Exposed</Label>
              <div className="flex items-center gap-3">
                <span className="text-sm text-white/60">No</span>
                <Switch
                  id="internet-exposed"
                  checked={internetExposed}
                  onCheckedChange={setInternetExposed}
                  disabled={isLoading}
                  style={{
                    backgroundColor: internetExposed ? hexColors.navy.light : undefined,
                  }}
                />
                <span className="text-sm text-white/60">Yes</span>
              </div>
            </div>
          </div>

          {/* Attack Complexity */}
          <div className="mt-6 space-y-2">
            <Label className="text-white">Attack Complexity</Label>
            <div className="flex gap-2">
              <Button
                variant={attackComplexity === 'low' ? 'default' : 'outline'}
                className="flex-1"
                onClick={() => setAttackComplexity('low')}
                disabled={isLoading}
                style={attackComplexity === 'low' ? { 
                  backgroundColor: hexColors.navy.DEFAULT, 
                  color: 'white' 
                } : {}}
              >
                Low
              </Button>
              <Button
                variant={attackComplexity === 'high' ? 'default' : 'outline'}
                className="flex-1"
                onClick={() => setAttackComplexity('high')}
                disabled={isLoading}
                style={attackComplexity === 'high' ? { 
                  backgroundColor: hexColors.navy.DEFAULT, 
                  color: 'white' 
                } : {}}
              >
                High
              </Button>
            </div>
          </div>

          {/* Asset Value */}
          <div className="mt-4 space-y-2">
            <Label className="text-white">Asset Value</Label>
            <div className="flex gap-2">
              <Button
                variant={assetValue === 'low' ? 'default' : 'outline'}
                className="flex-1 flex-col h-auto py-3"
                onClick={() => setAssetValue('low')}
                disabled={isLoading}
                style={assetValue === 'low' ? { 
                  backgroundColor: hexColors.navy.DEFAULT, 
                  color: 'white' 
                } : {}}
              >
                <div className="font-semibold">Low</div>
                <div className="text-xs opacity-90">Non-critical</div>
              </Button>
              <Button
                variant={assetValue === 'medium' ? 'default' : 'outline'}
                className="flex-1 flex-col h-auto py-3"
                onClick={() => setAssetValue('medium')}
                disabled={isLoading}
                style={assetValue === 'medium' ? { 
                  backgroundColor: hexColors.navy.DEFAULT, 
                  color: 'white' 
                } : {}}
              >
                <div className="font-semibold">Medium</div>
                <div className="text-xs opacity-70">Important</div>
              </Button>
              <Button
                variant={assetValue === 'critical' ? 'default' : 'outline'}
                className="flex-1 flex-col h-auto py-3"
                onClick={() => setAssetValue('critical')}
                disabled={isLoading}
                style={assetValue === 'critical' ? { 
                  backgroundColor: hexColors.navy.DEFAULT, 
                  color: 'white' 
                } : {}}
              >
                <div className="font-semibold">Critical</div>
                <div className="text-xs opacity-70">Business critical</div>
              </Button>
            </div>
          </div>

          {/* Predict Button */}
          <Button 
            className="w-full mt-6" 
            onClick={handleSubmit}
            disabled={isLoading}
            style={{ 
              background: isLoading 
                ? hexColors.navy.dark 
                : `linear-gradient(135deg, ${hexColors.navy.DEFAULT} 0%, ${hexColors.navy.dark} 100%)`,
              color: 'white',
              opacity: isLoading ? 0.7 : 1,
            }}
            onMouseEnter={(e) => {
              if (!isLoading) {
                e.currentTarget.style.background = `linear-gradient(135deg, ${hexColors.navy.dark} 0%, ${hexColors.navy.darker} 100%)`;
              }
            }}
            onMouseLeave={(e) => {
              if (!isLoading) {
                e.currentTarget.style.background = `linear-gradient(135deg, ${hexColors.navy.DEFAULT} 0%, ${hexColors.navy.dark} 100%)`;
              }
            }}
          >
            {isLoading ? (
              <>
                <Loader2 className="size-4 mr-2 animate-spin" />
                Analyzing Risk...
              </>
            ) : (
              <>
                <Zap className="size-4 mr-2" />
                Predict Risk Level
              </>
            )}
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}
